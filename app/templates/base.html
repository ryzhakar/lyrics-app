<!doctype html>
<html lang="en" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>Lyrics App</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Roboto+Slab:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/base.css" />
  </head>
  <body class="{{ 'dark' if dark else '' }} font-{{ font or 'normal' }}">
    <nav class="topbar">
      <div class="topbar-row">
        <a href="/" class="brand" aria-label="Home">Lyrics</a>
        <form action="/search" method="get" class="search">
          <input type="search" name="q" placeholder="Searchâ€¦" value="{{ query or '' }}" />
        </form>
        <div class="actions">
          <button type="button" class="icon-btn" id="theme-toggle" aria-label="Toggle theme" title="Toggle theme"><img id="theme-icon" src="https://cdn.jsdelivr.net/npm/@tabler/icons@3.11.0/icons/outline/moon.svg" width="22" height="22" alt=""></button>
          <button type="button" class="icon-btn" id="chords-toggle" aria-label="Toggle chords" title="Toggle chords"><img id="chords-icon" src="https://cdn.jsdelivr.net/npm/@tabler/icons@3.11.0/icons/outline/music.svg" width="22" height="22" alt=""></button>
          <button type="button" class="icon-btn" id="share-link" aria-label="Share" title="Share link"><img id="share-icon" src="https://cdn.jsdelivr.net/npm/@tabler/icons@3.11.0/icons/outline/share-2.svg" width="22" height="22" alt=""></button>
        </div>
      </div>
    </nav>
    <main class="container">
      {% block content %}{% endblock %}
    </main>
    <div id="toast" class="toast" role="status" aria-live="polite" aria-hidden="true"></div>
    <script>
      (function(){
        const qs = new URLSearchParams(window.location.search);
         const s = qs.get('s') || '';
        const font = qs.get('font') || '';
        const dark = qs.get('dark');
        const chords = qs.get('chords');
        const root = document.documentElement;
        const topbar = document.querySelector('.topbar');
        let lastScrollY = window.scrollY;
        let targetOffset = 0;
        function computeTopbar(){
          const h = topbar.getBoundingClientRect().height;
          root.style.setProperty('--topbar-h', `${h}px`);
          root.style.setProperty('--topbar-gap', `${Math.max(0, h - targetOffset)}px`);
        }
        function clamp(v, min, max){ return Math.max(min, Math.min(max, v)); }
        function onScroll(){
          const y = window.scrollY;
          const delta = y - lastScrollY;
          lastScrollY = y;
          const maxHide = topbar.getBoundingClientRect().height;
          targetOffset = clamp(targetOffset + delta, 0, maxHide);
          topbar.style.transform = `translateY(${-targetOffset}px)`;
          root.style.setProperty('--topbar-gap', `${Math.max(0, maxHide - targetOffset)}px`);
        }
        computeTopbar();
        if(window.ResizeObserver){ new ResizeObserver(computeTopbar).observe(topbar); }
        function setParam(name, value){
          const q = new URLSearchParams(window.location.search);
          if(value === null){ q.delete(name); } else { q.set(name, value); }
          window.location.search = q.toString();
        }
        function refreshIcons(){
          const darkOn = (new URLSearchParams(window.location.search).get('dark')||'0') === '1' || document.body.classList.contains('dark');
          const chordsOn = (new URLSearchParams(window.location.search).get('chords')||'1') === '1';
          const base = 'https://cdn.jsdelivr.net/npm/@tabler/icons@3.11.0/icons/';
          const themeSet = (document.body.classList.contains('dark') || darkOn) ? 'filled' : 'outline';
          document.getElementById('theme-icon').src = darkOn ? `${base}outline/sun.svg` : `${base}outline/moon.svg`;
          document.getElementById('chords-icon').src = chordsOn ? `${base}outline/eyeglass.svg` : `${base}outline/eyeglass-off.svg`;
        }
        // prevent iOS zoom jump by focusing next tick after setting font-size
        const searchInput = document.querySelector('.search input');
        if(searchInput){
          searchInput.addEventListener('focus', () => {
            // ensure caret aligns by forcing layout
            searchInput.style.webkitTextSizeAdjust = '100%';
          }, {passive:true});
        }
        refreshIcons();
        document.getElementById('theme-toggle').addEventListener('click', function(){
          const cur = (qs.get('dark')||'0') === '1';
          setParam('dark', cur ? '0' : '1');
        });
        document.getElementById('chords-toggle').addEventListener('click', function(){
          const cur = (qs.get('chords')||'1') === '1';
          setParam('chords', cur ? '0' : '1');
        });
        function showToast(text){
          const el = document.getElementById('toast');
          el.textContent = text; el.setAttribute('aria-hidden','false');
          el.classList.add('show');
          setTimeout(()=>{ el.classList.remove('show'); el.setAttribute('aria-hidden','true');}, 1600);
        }
        document.getElementById('share-link').addEventListener('click', async function(){
          const url = window.location.href;
          try{
            if(navigator.share){ await navigator.share({url}); showToast('Link shared'); return; }
            if(navigator.clipboard && window.isSecureContext){
              await navigator.clipboard.writeText(url);
              showToast('Link copied');
              return;
            }
            const ta = document.createElement('textarea');
            ta.value = url; ta.style.position = 'fixed'; ta.style.opacity = '0';
            document.body.appendChild(ta); ta.focus(); ta.select();
            const ok = document.execCommand('copy'); document.body.removeChild(ta);
            showToast(ok ? 'Link copied' : 'Open share sheet');
          }catch{ showToast('Could not share'); }
        });
        // Detent-style topbar hide/reveal without breaking sticky offsets
        window.addEventListener('scroll', onScroll, {passive:true});
        window.addEventListener('orientationchange', ()=>{ computeTopbar(); refreshIcons(); }, {passive:true});
        window.addEventListener('resize', ()=>{ computeTopbar(); refreshIcons(); }, {passive:true});
      })();
    </script>
  </body>
</html>
