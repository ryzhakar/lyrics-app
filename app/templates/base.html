<!doctype html>
<html lang="en" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>Lyrics App</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Roboto+Slab:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/base.css" />
  </head>
  <body class="{{ 'dark' if dark else '' }} font-{{ font or 'normal' }} {{ 'is-search' if is_search else 'is-song' }}">
    <nav class="topbar">
      <div class="topbar-row">
        <a href="/" class="brand" aria-label="Home">Lyrics</a>
        {% if is_search %}
        <div class="bar-spacer"></div>
        {% else %}
        <a href="/search" class="icon-btn" id="open-search" aria-label="Open search" title="Open search"><img src="https://cdn.jsdelivr.net/npm/@tabler/icons@3.11.0/icons/outline/search.svg" width="22" height="22" alt=""></a>
        {% endif %}
        <div class="actions">
          <button type="button" class="icon-btn" id="theme-toggle" aria-label="Toggle theme" title="Toggle theme"><img id="theme-icon" src="https://cdn.jsdelivr.net/npm/@tabler/icons@3.11.0/icons/outline/moon.svg" width="22" height="22" alt=""></button>
          {% if not is_search %}
          <button type="button" class="icon-btn" id="chords-toggle" aria-label="Toggle chords" title="Toggle chords"><img id="chords-icon" src="https://cdn.jsdelivr.net/npm/@tabler/icons@3.11.0/icons/outline/music.svg" width="22" height="22" alt=""></button>
          {% endif %}
          <button type="button" class="icon-btn" id="share-link" aria-label="Share" title="Share link"><img id="share-icon" src="https://cdn.jsdelivr.net/npm/@tabler/icons@3.11.0/icons/outline/share-2.svg" width="22" height="22" alt=""></button>
        </div>
      </div>
    </nav>
    <main class="container">
      {% block content %}{% endblock %}
    </main>

    <div id="toast" class="toast" role="status" aria-live="polite" aria-hidden="true"></div>
    <script>
      (function(){
        const qs = new URLSearchParams(window.location.search);
        const darkParam = qs.get('dark');
        if(darkParam === '1' || darkParam === '0'){ try{ localStorage.setItem('prefDark', darkParam); }catch{} }
        try{
          const savedDark = localStorage.getItem('prefDark');
          if(savedDark === '1'){ document.body.classList.add('dark'); }
          if(savedDark === '0'){ document.body.classList.remove('dark'); }
        }catch{}
        const s = qs.get('s') || '';
        if (window.location.pathname === '/' && !s) {
          try { window.__showSearchHero = true; history.replaceState(null, '', '/search' + (window.location.search || '')); } catch {}
        }
        function setParam(name, value){ const q = new URLSearchParams(window.location.search); if(value === null){ q.delete(name); } else { q.set(name, value); } window.location.search = q.toString(); }
        function refreshIcons(){ const darkOn = (new URLSearchParams(window.location.search).get('dark')||'0') === '1' || document.body.classList.contains('dark'); const chordsOn = (new URLSearchParams(window.location.search).get('chords')||'1') === '1'; const base = 'https://cdn.jsdelivr.net/npm/@tabler/icons@3.11.0/icons/'; const themeIcon = document.getElementById('theme-icon'); if(themeIcon){ themeIcon.src = darkOn ? `${base}outline/sun.svg` : `${base}outline/moon.svg`; } const chordsIcon = document.getElementById('chords-icon'); if(chordsIcon){ chordsIcon.src = chordsOn ? `${base}outline/eyeglass.svg` : `${base}outline/eyeglass-off.svg`; } }
        const searchInput = document.querySelector('.search input');
        if(searchInput){ searchInput.addEventListener('focus', () => { searchInput.style.webkitTextSizeAdjust = '100%'; }, {passive:true}); }
        refreshIcons();
        const themeToggle = document.getElementById('theme-toggle'); if(themeToggle){ themeToggle.addEventListener('click', function(){ const nowDark = document.body.classList.toggle('dark'); try{ localStorage.setItem('prefDark', nowDark ? '1' : '0'); }catch{} refreshIcons(); }); }
        const chordsToggle = document.getElementById('chords-toggle'); if(chordsToggle){ chordsToggle.addEventListener('click', function(){ const cur = (qs.get('chords')||'1') === '1'; setParam('chords', cur ? '0' : '1'); }); }
        function showToast(text){ const el = document.getElementById('toast'); el.textContent = text; el.setAttribute('aria-hidden','false'); el.classList.add('show'); setTimeout(()=>{ el.classList.remove('show'); el.setAttribute('aria-hidden','true');}, 1600); }
        document.getElementById('share-link').addEventListener('click', async function(){ const url = window.location.href; try{ if(navigator.share){ await navigator.share({url}); showToast('Link shared'); return; } if(navigator.clipboard && window.isSecureContext){ await navigator.clipboard.writeText(url); showToast('Link copied'); return; } const ta = document.createElement('textarea'); ta.value = url; ta.style.position = 'fixed'; ta.style.opacity = '0'; document.body.appendChild(ta); ta.focus(); ta.select(); const ok = document.execCommand('copy'); document.body.removeChild(ta); showToast(ok ? 'Link copied' : 'Open share sheet'); }catch{ showToast('Could not share'); }});
        const actions = document.querySelector('.actions');
        if(actions && window.location.pathname !== '/search'){
          const editBtn = document.createElement('a');
          editBtn.href = '#'; editBtn.className = 'icon-btn'; editBtn.id = 'edit-setlist'; editBtn.title = 'Edit setlist'; editBtn.setAttribute('aria-label','Edit setlist');
          editBtn.innerHTML = '<img src="https://cdn.jsdelivr.net/npm/@tabler/icons@3.11.0/icons/outline/edit.svg" width="22" height="22" alt="">';
          actions.appendChild(editBtn);
          editBtn.addEventListener('click', function(ev){ ev.preventDefault(); const sParam = (new URLSearchParams(window.location.search).get('s')||''); const url = sParam ? `/search?s=${encodeURIComponent(sParam)}` : '/search'; window.location.href = url; }, {passive:false});
        }
        window.addEventListener('orientationchange', ()=>{ refreshIcons(); }, {passive:true});
        window.addEventListener('resize', ()=>{ refreshIcons(); }, {passive:true});
        function parseSParam(raw){ if(!raw) return []; return raw.split(',').map(t=>t.trim()).filter(Boolean).map(token=>{ const [id, key] = token.split(':'); return {id, key: key || ''}; }); }
        function buildSParam(items){ return items.map(it=> it.key ? `${it.id}:${it.key}` : `${it.id}:`).join(','); }
        function parseKeyToken(key){ if(!key) return {root:'', minor:false}; const m = key.match(/^([A-G](?:#|b)?)(m)?$/); if(!m) return {root:'', minor:false}; return {root: m[1], minor: !!m[2]}; }
        function stepKey(key, dir){ const token = parseKeyToken(key); if(!token.root){ return key; } const list = token.minor ? CHROMATIC_MINOR_KEYS : CHROMATIC_MAJOR_KEYS; const idx = list.indexOf(key); if(idx < 0){ return key; } const next = (idx + (dir === 'up' ? 1 : -1) + 12) % 12; return list[next]; }
        const CIRCLE_MAJOR_KEYS = ['C','G','D','A','E','B','F#','Db','Ab','Eb','Bb','F'];
        const CIRCLE_MINOR_KEYS = ['Am','Em','Bm','F#m','C#m','G#m','D#m','Bbm','Fm','Cm','Gm','Dm'];
        const CHROMATIC_MAJOR_KEYS = ['C','Db','D','Eb','E','F','F#','G','Ab','A','Bb','B'];
        const CHROMATIC_MINOR_KEYS = ['Am','Bbm','Bm','Cm','C#m','Dm','D#m','Em','Fm','F#m','Gm','G#m'];
        function keysForContext(effectiveKey){ const t = parseKeyToken(effectiveKey); return t.minor ? CIRCLE_MINOR_KEYS : CIRCLE_MAJOR_KEYS; }
        function closeAnyKeyMenus(){ document.querySelectorAll('.key-popover').forEach(el=>el.remove()); document.querySelectorAll('.song-key').forEach(w=>w.classList.remove('menu-open')); }
        function setSongKey(songId, newKey){ const qs2 = new URLSearchParams(window.location.search); const items = parseSParam(qs2.get('s') || ''); const updated = items.map(it => it.id === songId ? {id: it.id, key: newKey} : it); qs2.set('s', buildSParam(updated)); window.location.search = qs2.toString(); }
        function saveScrollRestoreForWrap(wrap){ try{ const rect = wrap.getBoundingClientRect(); const songId = wrap.getAttribute('data-song-id'); sessionStorage.setItem('scrollRestore', JSON.stringify({ songId, desiredTop: rect.top })); }catch{} }
        function applyScrollRestore(){ try{ const raw = sessionStorage.getItem('scrollRestore'); if(!raw) return; sessionStorage.removeItem('scrollRestore'); const data = JSON.parse(raw); const el = document.querySelector(`.song-key[data-song-id="${data.songId}"]`); if(!el) return; const rect = el.getBoundingClientRect(); const dy = rect.top - data.desiredTop; const target = Math.max(0, window.scrollY + dy); window.scrollTo({top: target, left: 0, behavior: 'auto'}); }catch{} }
        function openKeyMenu(wrap){ closeAnyKeyMenus(); const songId = wrap.getAttribute('data-song-id'); const effectiveKey = wrap.getAttribute('data-effective-key') || wrap.getAttribute('data-default-key') || ''; const list = keysForContext(effectiveKey); const pop = document.createElement('div'); pop.className = 'key-popover'; list.forEach(k => { const btn = document.createElement('button'); btn.type = 'button'; const isActive = (k === effectiveKey); btn.className = 'key-option' + (isActive ? ' active' : ''); btn.textContent = k; btn.addEventListener('click', (ev)=>{ ev.stopPropagation(); saveScrollRestoreForWrap(wrap); setSongKey(songId, k); }, {passive:false}); pop.appendChild(btn); }); wrap.classList.add('menu-open'); wrap.appendChild(pop); const onDocClick = (ev)=>{ if(!wrap.contains(ev.target)){ closeAnyKeyMenus(); document.removeEventListener('click', onDocClick, true); document.removeEventListener('keydown', onKey, true); } }; const onKey = (ev)=>{ if(ev.key === 'Escape'){ closeAnyKeyMenus(); document.removeEventListener('click', onDocClick, true); document.removeEventListener('keydown', onKey, true); } }; setTimeout(()=>{ document.addEventListener('click', onDocClick, true); document.addEventListener('keydown', onKey, true); }, 0); }
        function onKeyLabelClick(ev){ const el = ev.currentTarget; const wrap = el.closest('.song-key'); if(!wrap) return; if(wrap.classList.contains('menu-open')){ closeAnyKeyMenus(); return; } openKeyMenu(wrap); }
        document.querySelectorAll('.song-key .key-label').forEach(lbl=>{ lbl.addEventListener('click', onKeyLabelClick, {passive:true}); });
        applyScrollRestore();
      })();
    </script>
  </body>
</html>
