{% extends "base.html" %}
{% block content %}
  <div class="selected-panel is-hidden" id="selected-panel" aria-live="polite">
    <div class="selected-header">
      <div class="selected-title">Selected (<span id="sel-count">0</span>)</div>
      <div class="selected-actions">
        <button type="button" class="icon-btn" id="open-setlist" aria-label="Open setlist" title="Open setlist">Open Setlist</button>
        <button type="button" class="icon-btn" id="clear-all" aria-label="Clear selection" title="Clear selection">Clear All</button>
      </div>
    </div>
    <ol class="selected-list" id="sel-list"></ol>
  </div>

  <div class="search-header">
    <form action="/search" method="get" class="search search-large">
      <input type="search" name="q" placeholder="Search songs, artists, or lyrics…" value="{{ query or '' }}" />
    </form>
  </div>

  <div class="results">
    {% for s in results %}
      <div class="result-row"
           data-id="{{ s.id }}"
           data-default-key="{{ s.default_key or '' }}"
           data-title="{{ s.translated_title }}"
           data-artist="{{ s.artist or '' }}">
        <div class="result-main">
          <a class="result-link" href="/?s={{ s.id }}:{{ s.default_key or '' }}">
            <div class="list-title">{{ s.translated_title }}</div>
            <div class="list-meta">
              {% if s.artist %}<span class="meta-item artist">{{ s.artist }}</span>{% endif %}
              {% if s.original_title %}<span class="dot"></span><span class="meta-item original">{{ s.original_title }}</span>{% endif %}
            </div>
          </a>
        </div>
        <div class="result-actions">
          <button type="button" class="icon-btn plus-btn" title="Add to setlist" aria-label="Add to setlist">+</button>
        </div>
      </div>
    {% endfor %}
  </div>

  <script>
    (function(){
      const forms = Array.from(document.querySelectorAll('form.search'));
      function ensureHiddenS(value){
        if(!forms.length) return;
        forms.forEach(f => {
          let hidden = f.querySelector('input[name="s"][type="hidden"]');
          if(!hidden){ hidden = document.createElement('input'); hidden.type = 'hidden'; hidden.name = 's'; f.appendChild(hidden); }
          hidden.value = value || '';
        });
      }
      function parseS(raw){
        if(!raw) return [];
        return raw.split(',').map(t=>t.trim()).filter(Boolean).map(token=>{
          const [id, key] = token.split(':');
          return {id, key: key || ''};
        });
      }
      function buildS(items){ return items.map(it=> it.key ? `${it.id}:${it.key}` : `${it.id}:`).join(','); }
      function getQS(){ return new URLSearchParams(window.location.search); }
      function setURLWithS(items){ const qs = getQS(); const s = buildS(items); if(s){ qs.set('s', s); } else { qs.delete('s'); } const url = `${window.location.pathname}?${qs.toString()}`; history.replaceState(null, '', url); ensureHiddenS(s); }

      // local key helpers (mirror of base template)
      function parseKeyToken(key){ if(!key) return {root:'', minor:false}; const m = key.match(/^([A-G](?:#|b)?)(m)?$/); if(!m) return {root:'', minor:false}; return {root: m[1], minor: !!m[2]}; }
      const CHROMATIC_MAJOR_KEYS = ['C','Db','D','Eb','E','F','F#','G','Ab','A','Bb','B'];
      const CHROMATIC_MINOR_KEYS = ['Am','Bbm','Bm','Cm','C#m','Dm','D#m','Em','Fm','F#m','Gm','G#m'];
      const CIRCLE_MAJOR_KEYS = ['C','G','D','A','E','B','F#','Db','Ab','Eb','Bb','F'];
      const CIRCLE_MINOR_KEYS = ['Am','Em','Bm','F#m','C#m','G#m','D#m','Bbm','Fm','Cm','Gm','Dm'];
      function keysForContext(effectiveKey){ const t = parseKeyToken(effectiveKey); return t.minor ? CIRCLE_MINOR_KEYS : CIRCLE_MAJOR_KEYS; }
      function stepKey(key, dir){ const t = parseKeyToken(key); if(!t.root) return key; const list = t.minor ? CHROMATIC_MINOR_KEYS : CHROMATIC_MAJOR_KEYS; const i = list.indexOf(key); if(i < 0) return key; const next = (i + (dir === 'up' ? 1 : -1) + 12) % 12; return list[next]; }

      const metaKey = 'setlistMeta';
      function readMeta(){ try{ return JSON.parse(sessionStorage.getItem(metaKey) || '{}'); }catch{ return {}; } }
      function writeMeta(meta){ try{ sessionStorage.setItem(metaKey, JSON.stringify(meta)); }catch{} }

      let selection = parseS(getQS().get('s') || '');
      ensureHiddenS(buildS(selection));

      const panel = document.getElementById('selected-panel');
      function syncPanelVisibility(){
        if(!panel) return;
        if(selection.length > 0){ panel.classList.remove('is-hidden'); } else { panel.classList.add('is-hidden'); }
      }

      function isSelected(id){ return selection.findIndex(it=>it.id===id) !== -1; }
      function renderPreservingHeader(){ const hdr = document.querySelector('.search-header'); const before = hdr ? hdr.getBoundingClientRect().top : null; render(); if(before !== null && hdr){ const after = hdr.getBoundingClientRect().top; const dy = after - before; if(Math.abs(dy) > 0){ window.scrollBy({top: dy, left: 0, behavior: 'auto'}); } } }
      function addSelection(id, key){ if(isSelected(id)) return; selection.push({id, key}); setURLWithS(selection); renderPreservingHeader(); }
      function removeSelection(id){ selection = selection.filter(it=>it.id!==id); setURLWithS(selection); renderPreservingHeader(); }
      function moveSelection(id, dir){ const idx = selection.findIndex(it=>it.id===id); if(idx === -1) return; const to = dir==='up' ? idx-1 : idx+1; if(to < 0 || to >= selection.length) return; const tmp = selection[idx]; selection[idx] = selection[to]; selection[to] = tmp; setURLWithS(selection); render(); }

      function render(){
        const list = document.getElementById('sel-list');
        const count = document.getElementById('sel-count');
        if(!list || !count) return;
        list.innerHTML = '';
        count.textContent = String(selection.length);
        syncPanelVisibility();
        const meta = readMeta();
        selection.forEach((it, i)=>{
          const li = document.createElement('li');
          li.className = 'selected-item';
          li.draggable = true;
          const title = (meta[it.id] && meta[it.id].title) || it.id;
          const artist = (meta[it.id] && meta[it.id].artist) || '';
          const defKey = (meta[it.id] && meta[it.id].default_key) || '';
          const stack = document.createElement('div');
          stack.className = 'sel-stack';
          const titleEl = document.createElement('div');
          titleEl.className = 'list-title';
          titleEl.textContent = title;
          stack.appendChild(titleEl);
          if (artist) { const a = document.createElement('div'); a.className = 'list-artist'; a.textContent = artist; stack.appendChild(a); }
          li.appendChild(stack);
          const keyWrap = document.createElement('div'); keyWrap.className = 'sel-key'; keyWrap.setAttribute('data-song-id', it.id); keyWrap.setAttribute('data-default-key', defKey); keyWrap.setAttribute('data-effective-key', it.key || defKey);
          const label = document.createElement('div'); label.className = 'key-label'; label.textContent = `Key: ${it.key || defKey || '\u00A0'}`;
          keyWrap.appendChild(label);
          li.appendChild(keyWrap);
          const controls = document.createElement('div'); controls.className = 'selected-controls';
          const rm = document.createElement('button'); rm.type = 'button'; rm.className = 'icon-btn remove-btn'; rm.textContent = '×'; rm.title = 'Remove'; rm.setAttribute('aria-label','Remove');
          rm.addEventListener('click', ()=> removeSelection(it.id), {passive:true});
          const drag = document.createElement('span'); drag.className = 'drag-handle icon-btn'; drag.innerHTML = '≡'; drag.title = 'Drag to reorder'; drag.setAttribute('aria-label','Drag to reorder');
          controls.appendChild(drag); controls.appendChild(rm);
          li.appendChild(controls);
          list.appendChild(li);
        });
        document.querySelectorAll('.result-row').forEach(row=>{
          const id = row.getAttribute('data-id');
          const idx = selection.findIndex(it=>it.id===id);
          const plus = row.querySelector('.plus-btn');
          const link = row.querySelector('.result-link');
          if(idx !== -1){
            row.classList.add('selected');
            if(plus){ plus.classList.add('is-active'); plus.textContent = String(idx+1); plus.setAttribute('title','Remove from setlist'); plus.setAttribute('aria-label','Remove from setlist'); }
          } else {
            row.classList.remove('selected');
            if(plus){ plus.classList.remove('is-active'); plus.textContent = '+'; plus.setAttribute('title','Add to setlist'); plus.setAttribute('aria-label','Add to setlist'); }
          }
          if(link){
            if(selection.length > 0){
              link.setAttribute('aria-disabled','true');
              link.setAttribute('tabindex','-1');
            } else {
              link.removeAttribute('aria-disabled');
              link.removeAttribute('tabindex');
            }
          }
        });
      }

      document.querySelectorAll('.plus-btn').forEach(btn=>{
        btn.addEventListener('click', function(ev){
          ev.preventDefault(); ev.stopPropagation();
          const row = this.closest('.result-row'); if(!row) return;
          const id = row.getAttribute('data-id');
          const defKey = row.getAttribute('data-default-key') || '';
          const meta = readMeta();
          meta[id] = {
            title: row.getAttribute('data-title') || id,
            artist: row.getAttribute('data-artist') || '',
            default_key: defKey,
          };
          writeMeta(meta);
          if(isSelected(id)){ removeSelection(id); } else { addSelection(id, defKey); }
        }, {passive:true});
      });

      const sel = document.getElementById('sel-list');
      let dragIndex = -1;
      let placeholder = null;
      let autoScrollTimer = null;
      function indexOfLi(node){ return Array.from(sel.children).indexOf(node); }
      function clearAutoScroll(){ if(autoScrollTimer){ cancelAnimationFrame(autoScrollTimer); autoScrollTimer = null; } }
      function maybeAutoScroll(y){ const edge = 56; const speed = 12; function step(){ const rect = sel.getBoundingClientRect(); if(y < rect.top + edge){ window.scrollBy(0, -speed); } else if(y > rect.bottom - edge){ window.scrollBy(0, speed); } autoScrollTimer = requestAnimationFrame(step); } clearAutoScroll(); autoScrollTimer = requestAnimationFrame(step); }
      function ensurePlaceholder(){ if(!placeholder){ placeholder = document.createElement('li'); placeholder.className = 'drop-placeholder'; } return placeholder; }
      function insertPlaceholderAt(targetLi, above){ const ph = ensurePlaceholder(); if(!targetLi){ sel.appendChild(ph); return; } if(above){ sel.insertBefore(ph, targetLi); } else { sel.insertBefore(ph, targetLi.nextSibling); } }
      sel.addEventListener('dragstart', (e)=>{
        const li = e.target.closest('li.selected-item'); if(!li) return;
        dragIndex = indexOfLi(li);
        e.dataTransfer.effectAllowed = 'move';
        li.classList.add('drag-hide');
        insertPlaceholderAt(li, true);
      });
      sel.addEventListener('dragover', (e)=>{
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        const overLi = e.target.closest('li.selected-item');
        const ph = ensurePlaceholder();
        if(overLi && overLi !== ph){
          const rect = overLi.getBoundingClientRect();
          const above = (e.clientY - rect.top) < (rect.height / 2);
          insertPlaceholderAt(overLi, above);
        } else if(!overLi && sel.children.length){
          sel.appendChild(ph);
        }
        maybeAutoScroll(e.clientY);
      });
      sel.addEventListener('drop', (e)=>{
        e.preventDefault();
        clearAutoScroll();
        const ph = ensurePlaceholder();
        const to = indexOfLi(ph);
        if(dragIndex !== -1 && to !== -1){
          const moved = selection.splice(dragIndex, 1)[0];
          const insertAt = to > dragIndex ? to - 1 : to;
          selection.splice(insertAt, 0, moved);
          setURLWithS(selection);
        }
        dragIndex = -1;
        ph.remove();
        placeholder = null;
        renderPreservingHeader();
      });
      sel.addEventListener('dragend', ()=>{
        clearAutoScroll();
        const hide = sel.querySelector('li.selected-item.drag-hide');
        if(hide) hide.classList.remove('drag-hide');
        if(placeholder){ placeholder.remove(); placeholder = null; }
      });

      // Delegate key switching and menu inside selected list
      sel.addEventListener('click', (e)=>{
        const label = e.target.closest('.sel-key .key-label');
        const opt = e.target.closest('.key-option');
        const li = e.target.closest('li.selected-item');
        if(label && li){
          e.preventDefault(); e.stopPropagation();
          const wrap = label.closest('.sel-key');
          document.querySelectorAll('.selected-list .key-popover').forEach(el=>el.remove());
          const songId = wrap.getAttribute('data-song-id');
          const idx = selection.findIndex(it=> it.id === songId);
          const effectiveKey = (idx !== -1 ? (selection[idx].key || '') : '') || wrap.getAttribute('data-default-key') || '';
          const list = keysForContext(effectiveKey);
          const pop = document.createElement('div');
          pop.className = 'key-popover';
          list.forEach(k => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'key-option' + (k === effectiveKey ? ' active' : '');
            btn.textContent = k;
            pop.appendChild(btn);
          });
          wrap.appendChild(pop);
          return;
        }
        if(opt){
          const wrap = opt.closest('.sel-key'); if(!wrap) return;
          const songId = wrap.getAttribute('data-song-id');
          const idx = selection.findIndex(it=> it.id === songId); if(idx === -1) return;
          const newKey = opt.textContent.trim();
          selection[idx] = {id: selection[idx].id, key: newKey};
          setURLWithS(selection);
          renderPreservingHeader();
          return;
        }
      });

      document.addEventListener('click', (e)=>{
        if(!e.target.closest('.selected-list .sel-key')){
          document.querySelectorAll('.selected-list .key-popover').forEach(el=>el.remove());
        }
      }, {capture:true, passive:true});

      const openBtn = document.getElementById('open-setlist');
      if(openBtn){ openBtn.addEventListener('click', function(){ const s = buildS(selection); const url = s ? `/?s=${encodeURIComponent(s)}` : '/'; window.location.href = url; }, {passive:true}); }
      const clearBtn = document.getElementById('clear-all');
      if(clearBtn){ clearBtn.addEventListener('click', function(){ selection = []; setURLWithS(selection); render(); }, {passive:true}); }

      if(forms.length){ forms.forEach(f => f.addEventListener('submit', function(){ ensureHiddenS(buildS(selection)); })); }

      function toggleHero(){
        const hero = document.getElementById('search-hero');
        const resultsWrap = document.querySelector('.results');
        const q = (new URLSearchParams(window.location.search).get('q') || '').trim();
        const isSearch = window.location.pathname === '/search';
        const shouldShow = (window.__showSearchHero || (isSearch && !q)) && document.querySelectorAll('.result-row').length === 0;
        if(hero){ hero.style.display = shouldShow ? 'grid' : 'none'; hero.setAttribute('aria-hidden', shouldShow ? 'false' : 'true'); }
        if(resultsWrap){ resultsWrap.classList.toggle('is-hidden', shouldShow); }
      }

      toggleHero();
      render();

      const resultsWrap = document.querySelector('.results');
      if(resultsWrap){
        resultsWrap.addEventListener('click', function(e){
          const link = e.target.closest('.result-link');
          if(!link) return;
          if(selection.length > 0){ e.preventDefault(); e.stopPropagation(); }
        }, {passive:false, capture:true});
      }

      sel.addEventListener('touchstart', (e)=>{
        const handle = e.target.closest('.drag-handle');
        const li = e.target.closest('li.selected-item');
        if(!li || !handle) return;
        e.preventDefault();
        dragIndex = indexOfLi(li);
        li.classList.add('drag-hide');
        insertPlaceholderAt(li, true);
      }, {passive:false});
      sel.addEventListener('touchmove', (e)=>{
        if(dragIndex === -1) return;
        const y = e.touches[0].clientY;
        const overLi = document.elementFromPoint(e.touches[0].clientX, y)?.closest('li.selected-item');
        const ph = ensurePlaceholder();
        if(overLi && overLi !== ph){
          const rect = overLi.getBoundingClientRect();
          const above = (y - rect.top) < (rect.height / 2);
          insertPlaceholderAt(overLi, above);
        } else if(!overLi && sel.children.length){
          sel.appendChild(ph);
        }
      }, {passive:false});
      sel.addEventListener('touchend', ()=>{
        if(dragIndex === -1) return;
        const ph = ensurePlaceholder();
        const to = indexOfLi(ph);
        if(dragIndex !== -1 && to !== -1){
          const moved = selection.splice(dragIndex, 1)[0];
          const insertAt = to > dragIndex ? to - 1 : to;
          selection.splice(insertAt, 0, moved);
          setURLWithS(selection);
        }
        dragIndex = -1;
        const hide = sel.querySelector('li.selected-item.drag-hide');
        if(hide) hide.classList.remove('drag-hide');
        ph.remove();
        placeholder = null;
        renderPreservingHeader();
      }, {passive:false});
    })();
  </script>
{% endblock %}
