{% extends "base.html" %}
{% block content %}
  <div id="search-hero" class="search-hero" aria-hidden="true">
    <div class="hero-center">
      <form action="/search" method="get" class="search search-large">
        <input type="search" name="q" placeholder="Search songs, artists, or lyrics…" value="{{ query or '' }}" />
      </form>
      <div class="hero-hint">Start typing to find songs. Add with the plus, tap title to open.</div>
    </div>
  </div>

  <div class="selected-panel is-hidden" id="selected-panel" aria-live="polite">
    <div class="selected-header">
      <div class="selected-title">Selected (<span id="sel-count">0</span>)</div>
      <div class="selected-actions">
        <button type="button" class="icon-btn" id="open-setlist" aria-label="Open setlist" title="Open setlist">Open Setlist</button>
        <button type="button" class="icon-btn" id="clear-all" aria-label="Clear selection" title="Clear selection">Clear All</button>
      </div>
    </div>
    <ol class="selected-list" id="sel-list"></ol>
  </div>

  <div class="results">
    {% for s in results %}
      <div class="result-row"
           data-id="{{ s.id }}"
           data-default-key="{{ s.default_key or '' }}"
           data-title="{{ s.translated_title }}"
           data-artist="{{ s.artist or '' }}">
        <div class="result-main">
          <a class="result-link" href="/?s={{ s.id }}:{{ s.default_key or '' }}">
            <div class="song-title">{{ s.translated_title }}</div>
            <div class="song-meta">
              {% if s.artist %}<span class="meta-item artist">{{ s.artist }}</span>{% endif %}
              {% if s.original_title %}<span class="dot"></span><span class="meta-item original">{{ s.original_title }}</span>{% endif %}
              {% if s.default_key %}<span class="dot"></span><span class="meta-item key">Key: {{ s.default_key }}</span>{% endif %}
            </div>
          </a>
        </div>
        <div class="result-actions">
          {% if s.youtube_url %}
            <a class="icon-link youtube" href="{{ s.youtube_url }}" target="_blank" rel="noopener" title="YouTube" aria-label="YouTube"></a>
          {% endif %}
          {% if s.songlink_url %}
            <a class="icon-link spotify" href="{{ s.songlink_url }}" target="_blank" rel="noopener" title="Streaming" aria-label="Streaming"></a>
          {% endif %}
          <button type="button" class="icon-btn plus-btn" title="Add to setlist" aria-label="Add to setlist">+</button>
        </div>
      </div>
    {% endfor %}
  </div>

  <script>
    (function(){
      const forms = Array.from(document.querySelectorAll('form.search'));
      function ensureHiddenS(value){
        if(!forms.length) return;
        forms.forEach(f => {
          let hidden = f.querySelector('input[name="s"][type="hidden"]');
          if(!hidden){ hidden = document.createElement('input'); hidden.type = 'hidden'; hidden.name = 's'; f.appendChild(hidden); }
          hidden.value = value || '';
        });
      }
      function parseS(raw){
        if(!raw) return [];
        return raw.split(',').map(t=>t.trim()).filter(Boolean).map(token=>{
          const [id, key] = token.split(':');
          return {id, key: key || ''};
        });
      }
      function buildS(items){ return items.map(it=> it.key ? `${it.id}:${it.key}` : `${it.id}:`).join(','); }
      function getQS(){ return new URLSearchParams(window.location.search); }
      function setURLWithS(items){ const qs = getQS(); const s = buildS(items); if(s){ qs.set('s', s); } else { qs.delete('s'); } const url = `${window.location.pathname}?${qs.toString()}`; history.replaceState(null, '', url); ensureHiddenS(s); }

      const metaKey = 'setlistMeta';
      function readMeta(){ try{ return JSON.parse(sessionStorage.getItem(metaKey) || '{}'); }catch{ return {}; } }
      function writeMeta(meta){ try{ sessionStorage.setItem(metaKey, JSON.stringify(meta)); }catch{} }

      let selection = parseS(getQS().get('s') || '');
      ensureHiddenS(buildS(selection));

      const panel = document.getElementById('selected-panel');
      function syncPanelVisibility(){
        if(!panel) return;
        if(selection.length > 0){ panel.classList.remove('is-hidden'); } else { panel.classList.add('is-hidden'); }
      }

      function isSelected(id){ return selection.findIndex(it=>it.id===id) !== -1; }
      function addSelection(id, key){ if(isSelected(id)) return; selection.push({id, key}); setURLWithS(selection); render(); }
      function removeSelection(id){ selection = selection.filter(it=>it.id!==id); setURLWithS(selection); render(); }
      function moveSelection(id, dir){ const idx = selection.findIndex(it=>it.id===id); if(idx === -1) return; const to = dir==='up' ? idx-1 : idx+1; if(to < 0 || to >= selection.length) return; const tmp = selection[idx]; selection[idx] = selection[to]; selection[to] = tmp; setURLWithS(selection); render(); }

      function render(){
        const list = document.getElementById('sel-list');
        const count = document.getElementById('sel-count');
        if(!list || !count) return;
        list.innerHTML = '';
        count.textContent = String(selection.length);
        syncPanelVisibility();
        const meta = readMeta();
        selection.forEach((it, i)=>{
          const li = document.createElement('li');
          li.className = 'selected-item';
          const title = (meta[it.id] && meta[it.id].title) || it.id;
          const artist = (meta[it.id] && meta[it.id].artist) || '';
          const defKey = (meta[it.id] && meta[it.id].default_key) || '';
          const stack = document.createElement('div');
          stack.className = 'song-stack';
          const titleEl = document.createElement('div');
          titleEl.className = 'song-title';
          titleEl.textContent = title;
          stack.appendChild(titleEl);
          const metaEl = document.createElement('div');
          metaEl.className = 'song-meta';
          if (artist) {
            const a = document.createElement('span'); a.className = 'meta-item artist'; a.textContent = artist; metaEl.appendChild(a);
          }
          if (defKey) {
            if (artist) { const dot = document.createElement('span'); dot.className = 'dot'; metaEl.appendChild(dot); }
            const k = document.createElement('span'); k.className = 'meta-item key'; k.textContent = `Key: ${defKey}`; metaEl.appendChild(k);
          }
          if (metaEl.childElementCount) { stack.appendChild(metaEl); }
          li.appendChild(stack);
          const controls = document.createElement('div'); controls.className = 'selected-controls';
          const up = document.createElement('button'); up.type = 'button'; up.className = 'icon-btn'; up.textContent = '↑'; up.title = 'Move up'; up.setAttribute('aria-label','Move up'); if(i===0){ up.disabled = true; }
          const down = document.createElement('button'); down.type = 'button'; down.className = 'icon-btn'; down.textContent = '↓'; down.title = 'Move down'; down.setAttribute('aria-label','Move down'); if(i===selection.length-1){ down.disabled = true; }
          const rm = document.createElement('button'); rm.type = 'button'; rm.className = 'icon-btn'; rm.textContent = '×'; rm.title = 'Remove'; rm.setAttribute('aria-label','Remove');
          up.addEventListener('click', ()=> moveSelection(it.id, 'up'), {passive:true});
          down.addEventListener('click', ()=> moveSelection(it.id, 'down'), {passive:true});
          rm.addEventListener('click', ()=> removeSelection(it.id), {passive:true});
          controls.appendChild(up); controls.appendChild(down); controls.appendChild(rm);
          li.appendChild(controls);
          list.appendChild(li);
        });
        document.querySelectorAll('.result-row').forEach(row=>{
          const id = row.getAttribute('data-id');
          const idx = selection.findIndex(it=>it.id===id);
          const plus = row.querySelector('.plus-btn');
          if(idx !== -1){
            row.classList.add('selected');
            if(plus){ plus.classList.add('is-active'); plus.textContent = String(idx+1); plus.setAttribute('title','Remove from setlist'); plus.setAttribute('aria-label','Remove from setlist'); }
          } else {
            row.classList.remove('selected');
            if(plus){ plus.classList.remove('is-active'); plus.textContent = '+'; plus.setAttribute('title','Add to setlist'); plus.setAttribute('aria-label','Add to setlist'); }
          }
        });
      }

      document.querySelectorAll('.plus-btn').forEach(btn=>{
        btn.addEventListener('click', function(ev){
          ev.preventDefault(); ev.stopPropagation();
          const row = this.closest('.result-row'); if(!row) return;
          const id = row.getAttribute('data-id');
          const defKey = row.getAttribute('data-default-key') || '';
          const meta = readMeta();
          meta[id] = {
            title: row.getAttribute('data-title') || id,
            artist: row.getAttribute('data-artist') || '',
            default_key: defKey,
          };
          writeMeta(meta);
          if(isSelected(id)){ removeSelection(id); } else { addSelection(id, defKey); }
        }, {passive:true});
      });

      const openBtn = document.getElementById('open-setlist');
      if(openBtn){ openBtn.addEventListener('click', function(){ const s = buildS(selection); const url = s ? `/?s=${encodeURIComponent(s)}` : '/'; window.location.href = url; }, {passive:true}); }
      const clearBtn = document.getElementById('clear-all');
      if(clearBtn){ clearBtn.addEventListener('click', function(){ selection = []; setURLWithS(selection); render(); }, {passive:true}); }

      if(forms.length){ forms.forEach(f => f.addEventListener('submit', function(){ ensureHiddenS(buildS(selection)); })); }

      function toggleHero(){
        const hero = document.getElementById('search-hero');
        const resultsWrap = document.querySelector('.results');
        const q = (new URLSearchParams(window.location.search).get('q') || '').trim();
        const isSearch = window.location.pathname === '/search';
        const shouldShow = (window.__showSearchHero || (isSearch && !q)) && document.querySelectorAll('.result-row').length === 0;
        if(hero){ hero.style.display = shouldShow ? 'grid' : 'none'; hero.setAttribute('aria-hidden', shouldShow ? 'false' : 'true'); }
        if(resultsWrap){ resultsWrap.classList.toggle('is-hidden', shouldShow); }
      }

      toggleHero();
      render();
    })();
  </script>
{% endblock %}
