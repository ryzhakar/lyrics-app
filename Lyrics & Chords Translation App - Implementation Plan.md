## Project Vision

### What This Is

A mobile-first web application for musicians to access translated song lyrics with synchronized chord notations during live performances. The app serves as a digital songbook that understands the unique needs of performers who need to read translations while playing music in real-time.

### Why It Exists

Musicians performing translated songs face a unique challenge: they need to see both the translated lyrics and the chord progressions simultaneously, often in different keys than the original, while actively performing. Traditional solutions like printed sheets are inflexible, hard to organize, and impossible to transpose on the fly. This app solves these problems by providing instant access to a searchable library of translations with intelligent chord handling, customizable keys, and performance-optimized display.

### Core Values

- **Performance-Ready**: Every design decision prioritizes the live performance context where users have instruments in their hands and can't fumble with complex interfaces
- **Musically Correct**: Chord transposition and display must be technically accurate, respecting musical theory including complex notations like slash chords
- **Mobile-First**: Designed for phone screens in performance settings, often in low light or outdoor conditions
- **Frictionless Sharing**: Setlists and song configurations are encoded in URLs, making them instantly shareable with band members
- **Admin Simplicity**: Adding new songs should be straightforward, using familiar ChordPro notation without requiring technical expertise

### User Journey

A worship leader preparing for Sunday service searches for "Amazing Grace" in their language, selects it along with four other songs, arranges them in performance order, transposes two of them to better keys for their vocalist, and shares the complete setlist URL with their guitarist. During the service, they seamlessly scroll through the songs with the interface snapping to include next verse and chorus, etc. sections, never losing their place while playing.

---

## Version 1.0: Minimum Playable Product

### Overview

The foundational version establishes the core rendering pipeline and basic discovery mechanisms. Every song is conceptually a setlist of one, setting up the architecture for multi-song support from day one.

### Database Architecture

#### Schema Design

```
songs table:
  id                 â†’ UUID (primary key, autogenerated with pg_crypto)
  original_title     â†’ VARCHAR(255)
  translated_title   â†’ VARCHAR(255) NOT NULL
  artist            â†’ VARCHAR(255)
  chordpro_content  â†’ TEXT NOT NULL
  default_key       â†’ VARCHAR(3)
  youtube_url       â†’ VARCHAR(500)
  songlink_url      â†’ VARCHAR(500)
  search_vector     â†’ TSVECTOR (generated)
  created_at        â†’ TIMESTAMP
  updated_at        â†’ TIMESTAMP

Indexes:
  - PRIMARY KEY on id
  - INDEX on translated_title
  - INDEX on artist
  - GIN INDEX on search_vector
  - INDEX on created_at DESC
```

#### Search Vector Generation

The search_vector should be automatically maintained via PostgreSQL trigger, combining:

- translated_title
- original_title
- artist
- stripped lyrics from chordpro_content

### ChordPro Parser Implementation

#### Supported Subset

The parser must handle these ChordPro elements:

- Chord annotations: `[C]`, `[Am7]`, `[D/F#]` (keep an eye on slash chords!)
- Generic section markers: `{start_of_section: Bridge}`, `{end_of_section}`

#### Parsing Pipeline

```
Raw ChordPro Text
    â†“
Tokenizer (line by line)
    â†“
Token Stream: [CHORD, TEXT, SECTION_START, TEXT, CHORD, ...]
    â†“
AST Builder (Abstract Syntax Tree)
    â†“
Song Structure: {
  sections: [
    {type: "verse", lines: [
      {
	      chords: ["C", null, "G"],
	      ch_indices: [0, 9, 15],
	      lyrics: "Amazing grace how",
	  },
      ...
    ]},
    ...
  ]
}
    â†“
Chord Transposition
    â†“
HTML Renderer
```

#### Monospace Chord Positioning

Since we're using monospace fonts for accuracy, the positioning algorithm:

1. Calculate character position of each chord in the original ChordPro line
2. Preserve these exact positions in the HTML output
3. Render as two-line blocks: chords above, lyrics below
4. Use `<pre>` tags or carefully calculated `<span>` elements with whitespace preservation

Example transformation:

```
Input:  "[C]Amazing gr[G]ace how [Am]sweet the [F]sound"
Output: C         G       Am        F
        Amazing grace how sweet the sound
```

#### Transposition Logic

Integration with python-chord library:

1. Extract chord symbols from ChordPro
2. Parse each chord using python-chord
3. Transpose by semitone interval
4. Handle slash chords musically (transpose both root and bass)
5. Preserve chord qualities (maj7, sus4, etc.)
6. Re-insert transposed chords into original positions

Transposition map for common keys:

```
From C to D: +2 semitones
From C to E: +4 semitones
From C to G: +7 semitones
etc.
```

### URL Structure and Routing

#### Single Song Route

```
/?s=<uuid>:<key>
/?s=abc-123:D

Optional parameters:
&dark=1        â†’ Enable dark mode
&chords=0      â†’ Hide chord symbols
&font=large    â†’ Font size modifier
```

#### Multi-Song Setlist Route

```
/?s=<uuid1>:<key1>,<uuid2>:<key2>,...
/?s=abc-123:C,def-456:G,ghi-789:Em

The order in URL defines the performance order
```

#### Parameter Validation

If the raw ChordPro content is not renderable â€“ it CANNOT be saved.

### Rendering Engine

#### Template Structure

```
Page Layout:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Header (collapsible)    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                         â”‚
â”‚   Song 1                â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚
â”‚   Verse 1               â”‚
â”‚   Chorus                â”‚
â”‚   Verse 2               â”‚
â”‚   ...                   â”‚
â”‚                         â”‚
â”‚   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•     â”‚  â† Song separator
â”‚                         â”‚
â”‚   Song 2                â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚
â”‚   ...                   â”‚
â”‚                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### CSS Architecture

Base styles using Pico CSS with custom overrides:

- Monospace font for chord/lyric sections
- System font for UI elements
- Dark mode via CSS custom properties
- Print styles that remove UI chrome

#### Responsive Design Breakpoints

- Mobile: 320px - 768px (primary target)
- Tablet: 769px - 1024px
- Desktop: 1025px+ (admin use primarily)

### Admin Interface with SQLAdmin

#### Configuration

ModelView for songs with:

- Custom form fields for ChordPro content (textarea)
- Inline validation warnings (blocking)
- Auto-save draft functionality
- Preset templates for common song structures

#### Validation System

Real-time validation providing warnings for:

- Unclosed section markers (-> unparseable)
- Invalid chord syntax (-> unparseable)
- Extremely long sections (-> warning, >20 lines)

Validation runs on blur, not on every keystroke, showing:

- Green checkmark: Valid ChordPro
- Yellow warning: Parseable but has issues
- Red X: Cannot parse (will not save)

### Basic Search Implementation

#### Search Interface

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ” Search...            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Results:                â”‚
â”‚                         â”‚
â”‚ Amazing Grace           â”‚
â”‚ John Newton | Key: G    â”‚
â”‚                         â”‚
â”‚ Amazing Love            â”‚
â”‚ Graham Kendrick | Key: Dâ”‚
â”‚                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Search Logic

Using PostgreSQL ILIKE for v1.0:
(THIS IS AN EXAMPLE)

```sql
WHERE
  translated_title ILIKE '%query%' OR
  artist ILIKE '%query%' OR
  chordpro_content ILIKE '%query%'
ORDER BY
  CASE
    WHEN translated_title ILIKE 'query%' THEN 1
    WHEN translated_title ILIKE '%query%' THEN 2
    WHEN artist ILIKE '%query%' THEN 3
    ELSE 4
  END
```

### Deployment Configuration

#### Application Structure
(THIS IS AN EXAMPLE, but the stack is valid)

```
lyrics-app/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ main.py           â†’ FastAPI application
â”‚   â”œâ”€â”€ models.py         â†’ SQLAlchemy models
â”‚   â”œâ”€â”€ parser.py         â†’ ChordPro parser
â”‚   â”œâ”€â”€ transposer.py     â†’ Chord transposition
â”‚   â”œâ”€â”€ admin.py          â†’ SQLAdmin config
â”‚   â””â”€â”€ templates/
â”‚       â”œâ”€â”€ base.html
â”‚       â”œâ”€â”€ song.html
â”‚       â””â”€â”€ search.html
â”œâ”€â”€ static/
â”‚   â”œâ”€â”€ css/
â”‚   â””â”€â”€ js/
â”œâ”€â”€ requirements.txt
â”œâ”€â”€ .env.example
â””â”€â”€ docker-compose.yml    â†’ Local development
```
Additionally, we should use `uv` for project management and `alembic` for migrations
#### Environment Variables

```
DATABASE_URL=postgresql://user:pass@localhost/lyrics
SECRET_KEY=<generated>
ADMIN_USERNAME=admin
ADMIN_PASSWORD_HASH=<bcrypt hash>
DEBUG=false
```

#### Dokku Deployment

Deployment steps:

1. Create Dokku app
2. Add PostgreSQL plugin
3. Set environment variables
4. Configure domain
5. Enable Let's Encrypt SSL
6. Deploy via git push

---

## Version 1.1: Searchable

### Overview

This iteration transforms the basic search into a powerful discovery and setlist-building interface, making it effortless to find songs and combine them into performance setlists.

### Enhanced Search with pg_trgm

#### Database Preparation

Enable the extension and create indexes:

```sql
CREATE EXTENSION IF NOT EXISTS pg_trgm;
CREATE INDEX songs_title_trgm ON songs USING gin (translated_title gin_trgm_ops);
CREATE INDEX songs_artist_trgm ON songs USING gin (artist gin_trgm_ops);
```

#### Fuzzy Search Algorithm

Implement similarity scoring:

1. Calculate trigram similarity for each field
2. Apply weights: title (0.5), artist (0.3), lyrics (0.2)
3. Combine scores with threshold of 0.3
4. Order by combined score descending

#### Search Result Ranking

```
Score calculation:
title_similarity * 0.5 +
artist_similarity * 0.3 +
lyrics_similarity * 0.2 +
(0.1 if exact word match in title) +
(0.05 if search term at start of title)
```

### Search-to-Setlist Interface

#### UI State Management

The interface maintains three states:

1. **Search Mode**: Default, no songs selected
2. **Selection Mode**: One or more songs selected
3. **Reorder Mode**: Adjusting selected song positions

#### Visual Design

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ” Search songs...          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Selected (2):               â”‚
â”‚ â‘  Amazing Grace        [Ã—]  â”‚ â† Selected songs
â”‚ â‘¡ How Great Thou Art  [Ã—]  â”‚    with order
â”‚ [Open Setlist] [Clear All]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Search Results:             â”‚
â”‚ â—‹ Blessed Assurance         â”‚ â† Unselected
â”‚ â‘¢ Holy, Holy, Holy         â”‚ â† Selected (3rd)
â”‚ â—‹ In Christ Alone          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Selection Persistence

Selections persist using:

1. Session storage for temporary persistence
2. URL state for shareable selections
3. Hidden form fields as fallback

When searching, maintain a Set of selected UUIDs and their order Map.

#### Click Behavior Logic

For each song in results:

- If unselected: Click â†’ Add to setlist (assign next number)
- If selected: Click â†’ Remove from setlist (renumber others)
- "Open" link â†’ Always opens single song view

#### Reordering Interaction

Arrow button system:

```
â‘  Song Title     [â†‘][â†“]
â‘¡ Another Song   [â†‘][â†“]
â‘¢ Third Song     [â†‘][â†“]
```

Behavior:

- Up arrow: Swap with previous (unless first)
- Down arrow: Swap with next (unless last)
- Visual feedback: Brief highlight on move
- Immediate URL update

### URL Generation System

#### Setlist URL Builder

Algorithm for generating setlist URLs:

1. Collect selected songs in order
2. Pair each UUID with its default key
3. Build comma-separated parameter string
4. Update browser URL without reload (History API)

Example transformation:

```
Selected songs:
- Amazing Grace (uuid-1) in G
- How Great (uuid-2) in D
- Be Thou (uuid-3) in default key

Generated URL:
/?s=uuid-1:G,uuid-2:D,uuid-3:Ebm
```

#### Share Functionality

Share button behavior:

1. Copy URL to clipboard
2. Show toast notification
3. On mobile: Trigger native share sheet if available

### Performance Optimizations

#### Search Debouncing

Implement 300ms debounce on search input:

1. User types
2. Cancel previous timeout
3. Set new timeout
4. After 300ms of no typing: execute search

---

## Version 1.2: Performable

### Overview

This iteration introduces the killer feature: intelligent section-based navigation that understands song structure, making it effortless to navigate during performance.

### Section-Based Sticky Scrolling

#### Section Detection Algorithm

Parse ChordPro sections into navigable units:

1. Identify section markers in parsed AST
2. Calculate line count per section
3. If section > viewport height: apply breaking rules
4. Generate section metadata

#### Section Breaking Rules

For oversized sections:

```
If section_height > viewport_height * 0.8:
  If section has empty lines:
    Break at empty lines (verse boundaries)
  Else if section has >8 lines:
    Break every 4 lines
  Else:
    Keep as single unit (allow standard scroll)
```

#### HTML Section Structure

```html
<article class="song">
  <header class="song-header">Title - Artist</header>

  <section class="song-section" data-section-type="verse" data-section-index="1">
    <h3 class="section-header">Verse 1</h3>
    <div class="section-content-part">
      <!-- Chord/lyric lines -->
    </div>
  </section>

  <section class="song-section" data-section-type="chorus">
    <h3 class="section-header">Chorus</h3>
    <div class="section-content-part">
      <!-- Chord/lyric lines -->
    </div>
  </section>
</article>
```

#### CSS Scroll Snap Implementation

```css
.song-container {
  scroll-snap-type: y proximity;
  scroll-padding-top: 2rem; /* Keep header visible */
}

.song-section {
  scroll-snap-align: start;
  scroll-margin-top: 2rem;
}

/* Sticky section headers */
.section-header {
  position: sticky;
  top: 0;
  background: var(--background-color);
  z-index: 10;
}
```

#### Scroll Behavior Tuning

Fine-tuning for performance use:

1. Proximity snapping
2. Smooth scroll with reduced motion respect
3. Snap to section part starts when scorlling down, to section ends when scrolling up.

### Performance Mode

#### Activation and UI Changes

Performance mode (`&mode=perform`):

1. Hide all navigation UI
2. Increase font size by 20%
3. Maximize content area
4. Disable accidental navigation
5. Enable wake lock
6. Show only essential controls

#### Visual Layout in Performance Mode

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Amazing Grace      [Ã—]  â”‚ â† Minimal header
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                         â”‚
â”‚   Verse 1               â”‚ â† Full screen content
â”‚   C         G           â”‚
â”‚   Amazing grace how     â”‚
â”‚   Am        F           â”‚
â”‚   sweet the sound       â”‚
â”‚                         â”‚
â”‚   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•       â”‚
â”‚                         â”‚
â”‚   Chorus                â”‚
â”‚   ...                   â”‚
â”‚                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Navigation Safeguards

Prevent accidental exits:

1. Disable swipe-back gesture
2. Require confirmation for navigation
3. Lock screen orientation if possible
4. Disable pull-to-refresh
5. Hide browser chrome on scroll

#### Wake Lock Implementation

Keep screen awake during performance:

```javascript
1. Request wake lock on mode activation
2. Re-acquire if page becomes visible
3. Release on mode exit
4. Fallback: NoSleep.js library for older browsers
```

### Admin Preview System

#### Live Preview Architecture

Split-panel interface in admin:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             â”‚             â”‚
â”‚  ChordPro   â”‚   Preview   â”‚
â”‚   Editor    â”‚   Render    â”‚
â”‚             â”‚             â”‚
â”‚             â”‚             â”‚
â”‚ [Warnings]  â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Preview Update Mechanism

1. Debounced parsing (500ms after typing stops)
2. Parse ChordPro in backend
3. Return rendered HTML + warnings
4. Update preview panel
5. Show validation status

#### Validation Feedback Types

Visual indicators for different issues:

- âš ï¸ Yellow: Non-critical issues (long sections, missing metadata)
- ğŸ”´ Red: Parse errors (unclosed tags, invalid syntax)
- âœ… Green: Valid and well-formed

#### Mobile Admin Adaptation

On mobile, preview as collapsible panel:

1. Edit mode: Full screen editor
2. Preview button: Slide-up preview
3. Toggle between modes
4. Maintain scroll position
